# 关系查询处理和查询优化
- 关系数据库系统的查询处理
	- **查询处理步骤**
		- 查询分析
		- 查询检查
		- 查询优化
		- 查询执行
	- 查询分析
		- 查询分析的任务：对查询语句进行扫描，词法分析和语句分析
			- 词法分析：从查询语句中识别出正确的语言符号
			- 语法分析：进行语法检查
	- 查询检查
		- 查询检查的任务 
			- 合法权检查
			- 视图转换
			- 安全性检查
			- 完整性初步检查
		- 根据数据字典中有关的模式定义检查与剧中的数据库对象，如关系名，属性名是否存在和有效
		- 如果是对视图操作，则要用试图消解方法把对使徒的操作转换成对基本表的操作
		- 根据数据字典中的用户权限和完整性约束定义对用户的存取权限进行检查
		- 检查通过后把SQL查询语句转换成额你不表示，即等价的**关系代数表达式**
		- 关系数据库管理系统一般都用查询树，也称为**语法分析树**来表示扩展的关系代数表达式
	- 查询优化
		- 查询优化的分类
			- 代数优化/逻辑优化：指关系代数表达式的优化
			- 物理优化：指存取路径和底层操作算法的选择
		- 查询优化的选择依据
			- 基于规则
			- 基于代价
			- 基于语义
	- 查询执行
		- 依据优化器得到的执行策略生成查询执行计划
		- 代码生成器执行查询计划的代码
		- **两种执行方法**
			- 自顶向下
			- 自底向上
	- 实现查询操作的算法示例
		- 选择操作的实现
			- 全表扫描法：
				- 对查询的基本表顺序扫描，注意检查每个远足是否满足选择条件，把满足条件的元组作为结果输出
				- 适合小表，不适合大表
			- 索引扫描方法
				- 适合于选择条件中的属性上有索引
				- 通过多因先找到满足条件的元组主码或元组指针，再通过元组指针直接在查询的基本表中找到元组
		- 连接操作的实现
			- 嵌套循环法:
				- 对外层循环的没一个元组，检索内层循环中的每一个元组
				- 检查这两个元组在连接条件上是否成立
				- 满足脚尖则串接后作为结果输出，直到外层循环表中的元组处理完为止
			- 排序-合并法
				- 如果连接的表中没有排好序，先对两表按连接属性排序
				- 取外层表中的一个元组，依次扫描内层表中满足条件的元组，当扫描到第一个不满足条件的元组时，返回外层表，取下一个元组
				- 重复此步骤至外层表扫描完
				- 特点
					- 两个表都只需要扫描一次
					- 如果原来两个表是无序的，执行时间要加上对两个表的排序时间
					- 对于大表，先排序后使用合并-排序法，总的时间一般仍会减少
			- 索引连接算法
			- Hash join算法
- 关系数据库的查询优化
	- 查询优化在关系数据库中有着非常重要的地位
	- 关系查询优化是影响关系数据库管理系统性能的关键因素
	- 由于关系表达式的语义级别很高，使关系系统可以从关系表达式中分析查询语义，提供了执行查询优化的可能性
	- 查询优化概述
		- 关系系统的查询优化
			- 式关系数据库管理系统实现的关键技术，又是关系系统的优点所在
			- 减轻了用户选择群驱路径的负担
		- 查询优化的优点
			- 用户不必考虑如何最好地表达查询以获得较好的效率
			- 系统可以比用户程序的优化做的更好
				- 优化器可以从数据字典中获取许多统计信息，而用户程序则难以获得这些信息
				- 如果数据库的物理统计信息改变了，系统可以自动对查询重新优化已选择相应的执行计划。
				- 优化器可以考虑几百种不同的执行计划，程序员一般只能考虑有限的几种可能性
				- 优化其中包含了很多复杂的优化技术，这些优化技术往往只有最好地程序员才能掌握。系统的自动优化相当于使得所有人都拥有这些技术
		- 关系数据库管理系统通过某种代价模型计算出各种查询执行策略的执行代价，然后选取代价最小的执行方案
		- 查询优化的总目标
			- 选择有效的策略
			- 求得给定的关系表达式的值
			- 使得查询代价最小（实际上式较小）
- 代数优化
	- 关系代数表达式等价变换规则
		- 代数优化策略：通过**对关系代数表达式的等价变换**来提高查询效率
	- 查询树的**启发式优化**
		- 算则运算尽可能先做
			- 再优化策略中这是最重要的，最基本的一条
		- 把投影运算和选择运算同时进行
			- 如有若干投影和选择运算，并且他们都对同一个关系操作，则可以在扫描此关系的同时完成所有的这些运算以免重复扫描关系
		- 把投影同其前或后的算双目运算结合起来，没有必要为了去掉某些字段而扫描一遍关系
		- 把某些选择同在它前面的笛卡儿积结合起来成为一个连接运算
		- 找出公共子表达式
		- 等价变换规则
			- 连接，笛卡儿积交换律
			- 连接，笛卡尔积结合律
			- 投影串接定律
				- Πa1,a2,a3..(Πb1,b2,b3...)(E) = Πa1,a2,a3..(E)
			- 选择串接定律
				- σF1∧F2∧…∧Fn(E) = σF1(σF2(…(σFn(E))…))。
			- 选择于投影的交换律
			- 选择于笛卡儿积的交换律
			- 选择与并的分配律
			- 选择与差的分配律
			- 选择对自然连接的分配律
		- 优化算法：
			- 利用等价变换规则把如σF1∧F2∧…∧Fn(E)变换为σF1(σF2(…(σFn(E))…))。
			- 对每一个选择，利用等价变换规则尽可能的把他移到树的叶端
			- 对每一个投影利用等价变换规则尽可能的移到叶端
			- 把选择和投影的串接合并成单个选择，单个投影，或一个选择跟一个投影，使多个选择或投影能同时执行，或在一次扫面中全部完成
- 物理优化
	- 代数优化改变查询语句中操作的次序和组合，不涉及底层的存取路径
	- 对于一个查询语句有许多中存取方案，他们的执行效率不同，仅仅进行代数优化是不够的
	- 物理优化就是要**选择高效合理的操作算法或存取路径**球的优化的查询计划
	- 方法
		- **基于规则的启发式优化**
		- **基于代价估算的优化**
		- **两者结合的优化**

# 例题见新ppt最后！！！